<!DOCTYPE html>
<html lang="hu">
<head>
	<meta charset="UTF-8">
	<title>Slop Library - Deluxe Edition</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<style>
		:root { 
			--bg-color: #121212; 
			--card-bg: #1e1e1e; 
			--text-color: #e0e0e0; 
			--accent: #ffcc00; 
			--danger: #ff4444; 
			--success: #44ff44;
		}
		body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 50px; }
		
		nav { 
			background: #252525; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; 
			border-bottom: 2px solid var(--accent); position: sticky; top: 0; z-index: 1000; 
		}
		.nav-logo { color: var(--accent); font-size: 1.2em; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }
		.nav-links { display: flex; gap: 15px; }
		nav button { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 8px 18px; cursor: pointer; border-radius: 5px; font-weight: bold; }
		nav button.active { background: var(--accent); color: #000; }

		.container { max-width: 1100px; margin: 20px auto; padding: 0 20px; }
		.page { display: none; }
		.page.active { display: block; }

		.module-box { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #444; margin-bottom: 20px; display: none; }
		.form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
		input, textarea, select { background: #2d2d2d; border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; flex: 1; }
		.ctrl-btn { padding: 12px; font-weight: bold; border-radius: 8px; border: 1px solid #444; background: #252525; color: white; cursor: pointer; flex: 1; transition: 0.2s; }
		.ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }
		.ctrl-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }

		.album-card { display: flex; background: var(--card-bg); border-radius: 10px; overflow: hidden; border: 1px solid #333; margin-bottom: 15px; position: relative; align-items: stretch; }
		.row-number { background: #333; color: #888; display: flex; align-items: center; justify-content: center; min-width: 40px; font-weight: bold; flex-shrink: 0; }
		.album-art-container {
			width: 180px; /* Ugyanaz a sz√©less√©g, amit a k√©pnek adt√°l */
			min-width: 180px; /* Hogy ne nyomja √∂ssze a sz√∂veg */
			display: flex;
			align-items: center; /* F√ºgg≈ëlegesen k√∂z√©pre teszi a k√©pet */
			justify-content: center; /* V√≠zszintesen k√∂z√©pre teszi a k√©pet */
			position: relative;
			overflow: hidden; /* Ez kell majd a hom√°lyos√≠tott h√°tt√©rhez */
			background: #151515; /* Egy s√∂t√©t alap, am√≠g t√∂lt a k√©p */
		}
		.album-art-blur {
			position: absolute;
			top: 50%;
			left: 50%;
			width: 120%; /* Kicsit nagyobb, hogy ne l√°tsz√≥djanak a sz√©lei a hom√°lyos√≠t√°s miatt */
			height: 120%;
			object-fit: cover;
			transform: translate(-50%, -50%) scale(1.2); /* K√∂z√©pre teszi √©s nagy√≠tja */
			filter: blur(12px) brightness(0.5); /* Itt √°ll√≠thatod a hom√°lyoss√°got √©s s√∂t√©ts√©get */
			z-index: 1; /* Alulra ker√ºl */
			pointer-events: none; /* Ne lehessen r√°kattintani */
		}
		.album-art {
			width: 160px; /* Kicsit kisebb, mint a kont√©ner, hogy legyen k√∂r√ºl√∂tte t√©r */
			height: 160px;
			object-fit: cover;
			border-radius: 4px;
			cursor: pointer;
			z-index: 2;
			position: relative;
			box-shadow: 0 4px 15px rgba(0,0,0,0.5); /* Egy kis √°rny√©k, hogy elv√°ljon a majdani h√°tt√©rt≈ël */
		}
		.album-info { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
		.artist-name { color: var(--accent); font-size: 1.2em; font-weight: bold; margin: 0; transition: 0.2s; cursor: pointer; display: inline-block; }
		.artist-name:hover { text-decoration: underline; color: #fff; }
		.score-badge { position: absolute; top: 15px; right: 15px; padding: 8px 12px; border-radius: 6px; font-weight: bold; color: white; }
		
		.review-text { font-size: 0.9em; font-style: italic; color: #bbb; margin-top: 10px; border-left: 2px solid var(--accent); padding-left: 10px; }
		.song-container { margin-top: 10px; font-size: 0.8em; }
		.song-label { color: #888; margin-right: 5px; }
		.fav-song-link { color: var(--accent); font-style: italic; text-decoration: underline; display: inline-block; }

		.btn-del { position: absolute; bottom: 10px; right: 10px; background: none; border: none; color: var(--accent); font-size: 1em; cursor: pointer; opacity: 0.6; transition: 0.2s; }
		.btn-del:hover { color: var(--danger); opacity: 1; transform: scale(1.1); }
		.btn-check { background: none; border: 2px solid var(--success); color: var(--success); font-size: 1.5em; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; margin-top: 10px; }

		.pagination-container { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; }
		.page-btns { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
		.page-btn { padding: 8px 14px; background: #252525; border: 1px solid #444; color: #fff; border-radius: 5px; cursor: pointer; font-weight: bold; }
		.page-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
		.page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

		.settings-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #252525; border-radius: 6px; margin-bottom: 5px; }

		.stats-grid {
			display: grid;
			grid-template-columns: 1fr 1fr; /* K√©t oszlop */
			gap: 20px;
			width: 100%; /* Ez biztos√≠tja, hogy a r√°cs kit√∂ltse a k√©perny≈ët */
			box-sizing: border-box;
			padding: 10px;
		}
		.full-width {
			grid-column: span 2; /* Az 1. oszlopt√≥l indul √©s 2 oszlopot fog √°t */
			width: 100%;
		}
		.stat-card { 
			background: var(--card-bg); 
			padding: 20px; 
			border-radius: 12px; 
			border: 1px solid #444; 
			min-width: 0;
			overflow:hidden;			
		}
		.clickable-list { list-style: none; padding: 0; }
		.clickable-list li { background: #252525; margin-bottom: 6px; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
		.stat-score-pill { padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9em; min-width: 35px; text-align: center; }

/* Mobilos n√©zet: minden k√°rtya legyen teljes sz√©less√©g≈± */
	@media (max-width: 800px) {
			.stats-grid {
				grid-template-columns: 1fr;
			}
			.full-width, .stat-card {
				grid-column: 1 / span 1;
			}
	}

		#lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
		#lightbox img { max-width: 90%; max-height: 90%; border: 3px solid var(--accent); }
	#listRecStats li {
		display: flex;
			justify-content: space-between;
		align-items: center;
			padding: 10px 15px;
	}

	/* Aj√°nl√≥ n√©vt√°bla st√≠lusa */
.recommender-container {
	display: flex;
	flex-direction: column;
	align-items: center;
	margin: 0 15px; /* T√°vols√°g a sz√∂vegt≈ël √©s a pontsz√°mt√≥l */
	min-width: fit-content;
}

.rec-label {
	font-size: 0.6rem;
	color: var(--accent);
	text-transform: uppercase;
	font-weight: bold;
	margin-bottom: 2px;
}

.recommender-tag {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	padding: 4px 10px;
	border-radius: 6px;
	border: 1.5px solid;
	line-height: 1.1;
	text-align: center;
	background: rgba(0,0,0,0.3);
}
.rec-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; white-space: nowrap; }
.rec-subtitle { font-size: 0.55rem; font-weight: 400; opacity: 0.8; margin-top: 2px; }
.album-card-right { display: flex; align-items: center; justify-content: flex-end; }

.traits-container {
	display: flex;
	flex-wrap: wrap;
	gap: 8px;
	margin: 10px 0;
	padding: 10px;
	background: rgba(0,0,0,0.2);
	border-radius: 8px;
	align-items: center;
}
.traits-title {
	font-size: 12px;
	font-weight: bold;
	color: var(--accent);
	margin-right: 5px;
	text-transform: uppercase;
}
.trait-pill {
	font-size: 12px;
	padding: 4px 6px;
	border-radius: 4px;
	background: #333;
	border: 1px solid #444;
	display: flex;
	flex-direction: column;
	align-items: center;
	min-width: 50px;
	line-weight: 1.2;
}
.trait-name { opacity: 0.7; font-size: 10px; margin-bottom: 1px; }
/* Sz√≠nk√≥dok a v√°laszokhoz */
.t-igen { color: #44ff44; text-shadow: 0 0 5px rgba(68,255,68,0.3); }
.t-nem { color: #ff4444; text-shadow: 0 0 5px rgba(255,68,68,0.3); }
.t-meh { color: #888888; }
.t-volt { color: #bb88ff; text-shadow: 0 0 5px rgba(187,136,255,0.3); }
.t-peak { color: #ffcc00; text-shadow: 0 0 8px rgba(255,204,0,0.6); font-weight: bold; }
.t-poop { color: #8b4513; text-shadow: 0 0 5px rgba(139,69,19,0.3); }

.btn-snap {
	position: absolute;
	top: 75px; /* Az X gomb alatt/felett */
	right: 23px;
	background: rgba(0,0,0,0.6);
	border: 1px solid var(--accent);
	color: var(--accent);
	border-radius: 50%;
	width: 30px;
	height: 30px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 16px;
	transition: all 0.2s;
	z-index: 10;
}
.btn-snap:hover {
	background: var(--accent);
	color: #000;
	}
/* --- ADMIN LOGIKA FIX --- */
/* 1. K√©nyszer√≠tett rejt√©s: Elrejtj√ºk a konkr√©t gombokat a funkci√≥juk alapj√°n */
#nav-settings, 
button[onclick="toggleMod('add')"], 
button[onclick^="editAlbum"], 
button[onclick^="window.editAlbum"], 
button[onclick^="deleteAlbum"], 
button[onclick^="window.deleteAlbum"] {
    display: none !important;
}

/* 2. Felfed√©s: Ha be vagyunk jelentkezve (is-admin a body-n) */
body.is-admin #nav-settings, 
body.is-admin button[onclick="toggleMod('add')"], 
body.is-admin button[onclick^="editAlbum"], 
body.is-admin button[onclick^="window.editAlbum"],
body.is-admin button[onclick^="deleteAlbum"],
body.is-admin button[onclick^="window.deleteAlbum"] {
    display: inline-block !important;
}

	</style>
</head>
<body>

<div id="lightbox" onclick="this.style.display='none'"><img id="lb-img" src=""></div>

<nav>
	<div class="nav-logo" onclick="handleTitleClick()" style="cursor: pointer; user-select: none;">Slop Library</div>
	<div class="nav-links">
		<button onclick="showPage('library')" id="nav-library" class="active">K√ñNYVT√ÅR</button>
		<button onclick="showPage('todo')" id="nav-todo">TO-DO</button>
		<button onclick="showPage('stats')" id="nav-stats">STATISZTIK√ÅK</button>
		<button onclick="showPage('settings')" id="nav-settings" class="admin-only">BE√ÅLL√çT√ÅSOK</button>
	</div>
</nav>

<div class="container">
	<div id="library" class="page active">
		<div class="form-row">
			<button onclick="toggleMod('add')" class="ctrl-btn admin-only">+ √öJ BEJEGYZ√âS</button>
			<button onclick="toggleMod('search')" class="ctrl-btn">SZ≈∞R√âS</button>
			<button onclick="resetFilters()" class="ctrl-btn" style="border-color: #666; color: #aaa;">ALAPHELYZET</button>
		</div>
		
		<div id="mod-add" class="module-box">
			<div class="form-row">
				<input type="text" id="inArtist" placeholder="El≈ëad√≥">
				<input type="text" id="inAlbum" placeholder="Album">
				<input type="text" id="inCover" placeholder="Bor√≠t√≥ URL">
			</div>
			<div id="ratingFields">
				<div class="form-row">
					<input type="number" id="inYear" placeholder="√âv">
					<input type="text" id="inGenre" placeholder="M≈±fajok">
			<label style="display:block; margin-top:10px; font-size:0.8em; color:var(--accent);">AJ√ÅNLOTTA:</label>
				<select id="inRec" style="width:100%; padding:10px; background:#2d2d2d; color:#fff; border:1px solid #444; border-radius:6px;">
					<option value="">-- Saj√°t felfedez√©s --</option>
					<option value="baal">The Almighty Baal</option>
					<option value="goatlord">Goatlord</option>
					<option value="caller">Caller of Slam Riffs</option>
					<option value="bacchus">Bacchus the Second</option>
					<option value="mammvth">The Mammvth Hvnter</option>
					<option value="gaben">X14Gaben88X</option>
				</select>
					<input type="number" id="inScore" placeholder="Pont" step="0.1">
				</div>
				<div class="form-row">
					<input type="text" id="inFavSong" placeholder="Kiemelt dal c√≠me">
					<input type="text" id="inSongUrl" placeholder="Link a dalhoz">
			<label>Hozz√°ad√°s d√°tuma (vagy ≈êsid≈ëkben, ha √ºres):</label>
			<input type="date" id="inDate" style="width:100%; padding:10px; margin-bottom:10px; background:#111; border:1px solid #444; color:white; border-radius:5px;">
				</div>
				<textarea id="inReview" placeholder="V√©lem√©ny..."></textarea>
				
				<div style="margin-top:15px; border-top:1px solid #444; padding-top:10px;">
					<h4 style="margin:0 0 10px 0; color:var(--accent); font-size:14px;">Teccet-e? (Traits)</h4>
					<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;" id="traitInputs">
					<div>
						<label style="font-size:11px; display:block;">Riffek</label>
						<select id="t_riff" class="trait-sel">
							<option value="Volt??">Volt??</option>
							<option value="Poop">Poop</option>
							<option value="Nem">Nem</option>
							<option value="Meh">Meh</option>
							<option value="Igen">Igen</option>
							<option value="Peak">Peak</option>
						</select>
					</div>
					<div>
						<label style="font-size:11px; display:block;">Vox</label>
						<select id="t_vox" class="trait-sel">
							<option value="Volt??">Volt??</option>
							<option value="Poop">Poop</option>
							<option value="Nem">Nem</option>
							<option value="Meh">Meh</option>
							<option value="Igen">Igen</option>
							<option value="Peak">Peak</option>
						</select>
					</div>
					<div>
						<label style="font-size:11px; display:block;">Dobok</label>
						<select id="t_dob" class="trait-sel">
							<option value="Volt??">Volt??</option>
							<option value="Poop">Poop</option>
							<option value="Nem">Nem</option>
							<option value="Meh">Meh</option>
							<option value="Igen">Igen</option>
							<option value="Peak">Peak</option>
						</select>
					</div>
					<div>
						<label style="font-size:11px; display:block;">Mix</label>
						<select id="t_mix" class="trait-sel">
							<option value="Volt??">Volt??</option>
							<option value="Poop">Poop</option>
							<option value="Nem">Nem</option>
							<option value="Meh">Meh</option>
							<option value="Igen">Igen</option>
							<option value="Peak">Peak</option>
						</select>
					</div>
					<div>
						<label style="font-size:11px; display:block;">Sz√∂veg</label>
						<select id="t_szoveg" class="trait-sel">
							<option value="Volt??">Volt??</option>
							<option value="Poop">Poop</option>
							<option value="Nem">Nem</option>
							<option value="Meh">Meh</option>
							<option value="Igen">Igen</option>
							<option value="Peak">Peak</option>
						</select>
					</div>
					<div>
						<label style="font-size:11px; display:block;">Vibe</label>
						<select id="t_vibe" class="trait-sel">
							<option value="Volt??">Volt??</option>
							<option value="Poop">Poop</option>
							<option value="Nem">Nem</option>
							<option value="Meh">Meh</option>
							<option value="Igen">Igen</option>
							<option value="Peak">Peak</option>
						</select>
					</div>
				</div>
			</div>
				
			</div>
			<div class="form-row">
				<select id="inTarget">
					<option value="library">√ârt√©kel√©s (K√∂nyvt√°r)</option>
					<option value="todo">K√©s≈ëbb (To-Do)</option>
				</select>
				<button onclick="saveAlbum()" class="ctrl-btn" style="background:var(--accent); color:#000; border:none; flex:2;">MENT√âS</button>
			</div>
		</div>

		<div id="mod-search" class="module-box" style="display:block;">
	<div class="form-row">
		<input type="text" id="gSearch" placeholder="Keres√©s..." oninput="currentPage=1; runFilter()">
		<select id="fArtist" onchange="currentPage=1; runFilter()"><option value="">√ñsszes el≈ëad√≥</option></select>
		<select id="fYear" onchange="currentPage=1; runFilter()"><option value="">√ñsszes √©v</option></select>
		<select id="fGenre" onchange="currentPage=1; runFilter()"><option value="">Minden m≈±faj</option></select>
	</div>
	<div class="form-row" style="margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">
		<span style="font-size: 0.8em; color: var(--accent); font-weight: bold;">RENDEZ√âS:</span>
		<select id="sortField" onchange="currentPage=1; runFilter()" style="flex: 2;">
			<option value="id">Hozz√°ad√°s sorrendje (Alap√©rtelmezett)</option>
			<option value="artist">El≈ëad√≥ n√©v</option>
			<option value="album">Album c√≠m</option>
			<option value="year">√âvsz√°m</option>
			<option value="genre">M≈±faj</option>
			<option value="score">Pontsz√°m</option>
		</select>
		<button onclick="toggleSortOrder()" class="ctrl-btn" style="max-width: 50px;" title="Ir√°ny megford√≠t√°sa">
			<span id="sortDirIcon">‚ñº</span>
		</button>
	</div>
</div>
		<div id="listContainer"></div>
	</div>

	<div id="todo" class="page">
		<h2 style="color:var(--accent)">Meghallgat√°sra v√°r</h2>
		<div id="todoContainer"></div>
	</div>

	<div id="stats" class="page">
		<div class="stats-grid">


			<div class="stat-card full-width">
				<h3>Id≈ëvonal</h3>
				<div style="height:220px">
					<canvas id="cYear"></canvas>
				</div>
			</div>

		   
			<div class="stat-card full-width" style="display: flex; justify-content: space-around; text-align: center; padding: 20px 0; background: #252525; border: 1px solid #333;">
				<div>
					<small style="color:var(--accent); text-transform: uppercase; letter-spacing: 1px;">Albumok</small>
					<div id="stat-total-albums" style="font-size: 1.6em; font-weight: bold; color: #fff;">0</div>
				</div>
				<div>
					<small style="color:var(--accent); text-transform: uppercase; letter-spacing: 1px;">El≈ëad√≥k</small>
					<div id="stat-total-artists" style="font-size: 1.6em; font-weight: bold; color: #fff;">0</div>
				</div>
				<div>
					<small style="color:var(--accent); text-transform: uppercase; letter-spacing: 1px;">M≈±fajok</small>
					<div id="stat-total-genres" style="font-size: 1.6em; font-weight: bold; color: #fff;">0</div>
				</div>
				<div>
					<small style="color:var(--accent); text-transform: uppercase; letter-spacing: 1px;">√ñssz √Åtl.</small>
					<div id="stat-avg-score" style="font-size: 1.6em; font-weight: bold; color: #fff;">0</div>
				</div>
				<div>
					<small style="color:var(--accent); text-transform: uppercase; letter-spacing: 1px;">√ñssz yap</small>
					<div id="stat-total-yap" style="font-size: 1.6em; font-weight: bold; color: #fff;">0 sz√≥</div>
				</div>
			</div>


			<div class="stat-card">
				<h3>M≈±fajok eloszl√°sa</h3>
				<div style="height:400px">
					<canvas id="cGenre"></canvas>
				</div>
			</div>

			<div class="stat-card">
				<h3>Slop-O-Meter</h3>
				<div style="height:350px; width:120px; margin:auto;">
					<canvas id="cSlop"></canvas>
				</div>
			</div>

			<div class="stat-card full-width">
				<h3>√ârt√©kel√©sek eloszl√°sa</h3>
				<div style="height: 220px; width: 97%;">
					<canvas id="cScoreDist"></canvas>
				</div>
			</div>

			<div class="stat-card">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
				<h3 id="topTitle" style="margin: 0;">Top 10</h3>
					<button onclick="toggleTopSort()" class="ctrl-btn" style="max-width: 40px; padding: 5px; margin: 0; display: flex; align-items: center; justify-content: center;" title="Sorrend megford√≠t√°sa">
					<span id="sortIcon">‚áÖ</span>
					</button>
				</div>
				<div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
					<div>
						<h4 style="color:var(--accent); border-bottom: 1px solid #333; padding-bottom: 5px;">M≈±fajok</h4>
						<ul id="topG" class="clickable-list"></ul>
					</div>
					<div>
						<h4 style="color:var(--accent); border-bottom: 1px solid #333; padding-bottom: 5px;">√âvek</h4>
						<ul id="topY" class="clickable-list"></ul>
					</div>
				</div>
			</div>


		<div class="stat-card">
			   <h3>Aj√°nl√°sok adatai</h3>
				<ul id="listRecStats" class="clickable-list" style="display: flex; flex-direction: column; gap: 10px;">
					  </ul>
		</div>

		<div class="stat-card full-width">
			<h3>Teccett-e?</h3>
			<div style="height: 300px; position: relative;">
				<canvas id="chartTraits"></canvas>
			</div>
		</div>

		<div class="stat-card full-width">
				<h3>Ritkas√°gok</h3>
				<ul id="listRare" class="clickable-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;"></ul>
		</div>
			
	<div style="text-align: center; margin-top: 30px;">
		<button onclick="captureStats()" class="ctrl-btn" style="background: var(--accent); color: #000; max-width: 300px;">
			 STATISZTIKA M√ÅSOL√ÅSA V√ÅG√ìLAPRA
		</button>
		<p id="snapshotMsg" style="color: var(--success); display: none; margin-top: 10px;">K√©p a v√°g√≥lapra m√°solva!</p>
	</div>
</div>
		</div>
	</div>

	<div id="settings" class="page">
		<div class="stat-card" style="margin-bottom:20px;">
			<h3>Ritkas√°gi k√ºsz√∂b</h3>
			<div class="form-row">
				<input type="number" id="setRareLimit" onchange="rareLimit=parseInt(this.value); localStorage.setItem('slopRareLimit', rareLimit); renderSettings();"> 
				<span>(Enn√©l kevesebb albummal rendelkez≈ë m≈±fajok sz√°m√≠tanak ritk√°nak)</span>
			</div>
		</div>
		<div class="stat-card" style="margin-bottom:20px;">
			<h3>Slop m≈±fajok be√°ll√≠t√°sa</h3>
			<div id="setG" style="max-height:300px; overflow-y:auto; padding-right:10px;"></div>
		</div>
		<div class="stat-card" style="margin-bottom:20px;">
			<h3>CSV Import</h3>
			<p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">artist;album;year;genre;score;cover;review;favorite;link</p>
			<input type="file" id="csvFileInput" accept=".csv" style="margin-bottom: 10px;">
			<button onclick="handleCSV()" class="ctrl-btn" style="background:var(--accent); color:#000;">IMPORT√ÅL√ÅS</button>
		</div>
		<button onclick="if(confirm('T√∂r√∂lsz mindent?')) {localStorage.clear(); location.reload();}" class="ctrl-btn" style="background:var(--danger); margin-top:20px;">ADATOK T√ñRL√âSE</button>
	</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
	// https://firebase.google.com/docs/web/setup#available-libraries

	const firebaseConfig = {
	apiKey: "AIzaSyB8vcEb3IvLNqT2R6xS_ax_cm0WFV1fRC8",
	authDomain: "slop-library.firebaseapp.com",
	projectId: "slop-library",
	storageBucket: "slop-library.firebasestorage.app",
	messagingSenderId: "730801831303",
	appId: "1:730801831303:web:be74d9cb6d8b21de7f2722"
	};

	const app = initializeApp(firebaseConfig);
	const db = getFirestore(app);
	const auth = getAuth(app); // Auth inicializ√°l√°sa
	const provider = new GoogleAuthProvider();
	
	let currentUser = null; // Itt t√°roljuk, be vagyunk-e jelentkezve

	// Kattint√°s sz√°ml√°l√≥ a c√≠mre
	let titleClickCount = 0;
	window.handleTitleClick = function() {
		titleClickCount++;
		if (titleClickCount === 3) {
			titleClickCount = 0;
			if (!currentUser) {
				login();
			} else {
				if(confirm("Ki akarsz jelentkezni?")) logout();
			}
		}
		// 2 m√°sodperc ut√°n alaphelyzetbe √°ll a sz√°ml√°l√≥, ha nem j√∂tt meg a 3 kattint√°s
		setTimeout(() => { titleClickCount = 0; }, 2000);
	};

	// Bejelentkez√©s
	async function login() {
		try {
			await signInWithPopup(auth, provider);
		} catch (error) {
			console.error("Bejelentkez√©si hiba:", error);
		}
	}

	// Kijelentkez√©s
	async function logout() {
		await signOut(auth);
		location.reload(); // Tisztas√°gi √∫jrat√∂lt√©s
	}

	// FIGYEL≈ê: Ez fut le minden v√°ltoz√°sn√°l (be/kijelentkez√©s)
	onAuthStateChanged(auth, (user) => {
		currentUser = user;
		const adminUI = document.querySelectorAll('.admin-only'); // CSS oszt√°ly az elemekre
		const settingsMenu = document.querySelector('button[onclick*="settings"]');
		
		if (user) {
			console.log("Bejelentkezve:", user.email);
			// Ha be van jelentkezve: minden l√°tszik
			document.body.classList.add('is-admin');
			if(settingsMenu) settingsMenu.style.display = 'inline-block';
		} else {
			console.log("Vend√©g m√≥d");
			// Ha nincs bejelentkezve: korl√°toz√°sok
			document.body.classList.remove('is-admin');
			if(settingsMenu) settingsMenu.style.display = 'none';
			window.showPage('library'); // Ne maradjon a be√°ll√≠t√°sokon, ha kijelentkezik
		}
		runFilter(); // K√°rty√°k √∫jrarajzol√°sa a szerkeszt√©s gomb miatt
	});


	//aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
	Chart.defaults.devicePixelRatio = 3;
	Chart.register(ChartDataLabels);
	let sortAsc = false;
	let albums = [];
		async function loadFromFirebase() {
			try {
				const docRef = doc(db, "data", "library");
				const docSnap = await getDoc(docRef);

				if (docSnap.exists()) {
					albums = docSnap.data().albums || [];
					console.log("üî• Adatok bet√∂ltve a Firebase-b≈ël!");
				} else {
					console.log("‚ÑπÔ∏è Nincs adat a Firebase-ben, √ºres lista.");
					// Opcion√°lis: Ha els≈ë alkalommal m√©sz fel, √°th√∫zhatod a localstorage-b√≥l:
					// albums = JSON.parse(localStorage.getItem('slopLibrary')) || [];
				}
				runFilter(); // Lista kirajzol√°sa
			} catch (e) {
				console.error("Hiba a bet√∂lt√©s sor√°n: ", e);
			}
		}

	loadFromFirebase();
	
	let todos = JSON.parse(localStorage.getItem('slopTodo')) || [];
	let slopG = JSON.parse(localStorage.getItem('slopSettings')) || [];
	let charts = {};
	let editIdx = -1;
	let currentPage = 1;
	let itemsPerPage = 25;
	let topSortAsc = false;
	let rareLimit = parseInt(localStorage.getItem('slopRareLimit')) || 3;


	const recommenders = {
		"baal": { name1: "The Almighty Baal", name2: "Menace of Bikini Bottom", color: "#FFEB3B" },
		"goatlord": { name1: "Goatlord", name2: "Heir to the Black/Speed Throne", color: "#606060", textColor: "#bbb" },
		"caller": { name1: "Caller of Slam Riffs", name2: "Desecrator of Snare Drums", color: "#1E88E5" },
		"bacchus": { name1: "Bacchus the Second", name2: "the Sodomizer, the Bluntripper", color: "#4CAF50" },
		"mammvth": { name1: "The Mammvth Hvnter", name2: "He Who Preys on Dissodeath", color: "#8D6E63" },
		"gaben": { name1: "X14Gaben88X", name2: "Straightest of all Edges", color: "#AB47BC" }
	};

	window.toggleSortOrder = function() {
		sortAsc = !sortAsc;
		document.getElementById('sortDirIcon').innerText = sortAsc ? "‚ñ≤" : "‚ñº";
		currentPage = 1;
		runFilter();
	}

	window.getRecommenderHTML = function(recKey) {
		if (!recKey || !recommenders[recKey]) return "";
		const data = recommenders[recKey];
		const displayTextColor = data.textColor || data.color;
		return `
			<div class="recommender-container">
				<span class="rec-label">Aj√°nlotta:</span>
				<div class="recommender-tag" style="border-color: ${data.color}; color: ${displayTextColor};">
					<span class="rec-title">${data.name1}</span>
					<span class="rec-subtitle">${data.name2}</span>
				</div>
			</div>`;
	}

	window.toggleTopSort = function() {
		topSortAsc = !topSortAsc;
		document.getElementById('sortIcon').innerText = topSortAsc ? '‚áµ' : '‚áÖ';
		renderStats();
	}

	window.showPage = function(id) {
		document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
		document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
		const target = document.getElementById(id);
		if(target) target.classList.add('active');
		const btn = document.getElementById('nav-' + id);
		if(btn) btn.classList.add('active');
		
		if(id === 'stats') renderStats();
		if(id === 'library') { initFilters(); runFilter(); }
		if(id === 'settings') renderSettings();
		if(id === 'todo') renderTodo();
	}

	window.toggleMod = function(m) {
		const a = document.getElementById('mod-add'), s = document.getElementById('mod-search');
		if(m === 'add') { a.style.display = (a.style.display==='block'?'none':'block'); s.style.display='none'; }
		else { s.style.display = (s.style.display==='block'?'none':'block'); a.style.display='none'; }
	}

	window.saveAlbum = async function() {
		const target = document.getElementById('inTarget').value;
		const dateEl = document.getElementById('inDate');
		const dateInput = dateEl ? dateEl.value : '';
		const traits = {
			riff: document.getElementById('t_riff').value,
			vox: document.getElementById('t_vox').value,
			dob: document.getElementById('t_dob').value,
			mix: document.getElementById('t_mix').value,
			szoveg: document.getElementById('t_szoveg').value,
			vibe: document.getElementById('t_vibe').value
		};

		const a = {
			artist: document.getElementById('inArtist').value.trim(),
			album: document.getElementById('inAlbum').value.trim(),
			coverUrl: document.getElementById('inCover').value.trim(),
			year: document.getElementById('inYear').value,
			genre: document.getElementById('inGenre').value.trim(),
			recommender: document.getElementById('inRec').value,
			myScore: parseFloat(document.getElementById('inScore').value) || 0,
			review: document.getElementById('inReview').value.trim(),
			favSong: document.getElementById('inFavSong').value.trim(),
			songUrl: document.getElementById('inSongUrl').value.trim(),
			traits: traits,
			addedDate: dateInput || '≈êsid≈ëkben'
		};

		if(target === 'todo') {
			todos.push({ artist: a.artist, album: a.album, coverUrl: a.coverUrl, recommender: a.recommender });
			localStorage.setItem('slopTodo', JSON.stringify(todos));
		} else {
			if(editIdx > -1) { 
				albums[editIdx] = a; 
				editIdx = -1; 
			} else {
				albums.push(a);
			}
			await saveToFirebase(); 
		}
		location.reload();
	}

	window.renderList = function(data) {
		const container = document.getElementById('listContainer');
		if(!container) return;
		container.innerHTML = '';
		const totalItems = data.length;
		const totalPages = Math.ceil(totalItems / itemsPerPage);
		if (currentPage > totalPages) currentPage = totalPages || 1;
		const start = (currentPage - 1) * itemsPerPage;
		const end = start + itemsPerPage;
		const paginatedData = data.slice(start, end);

		paginatedData.forEach(a => {
			const idx = albums.indexOf(a);
			const songLabel = a.myScore > 4.5 ? "Kiemelked≈ë dal:" : "Legkev√©sb√© rossz dal:";
			const getTClass = (val) => {
				if(val === 'Peak') return 't-peak';
				if(val === 'Igen') return 't-igen';
				if(val === 'Nem') return 't-nem';
				if(val === 'Volt??') return 't-volt';
				if(val === 'Poop') return 't-poop';
				return 't-meh';
			};

			const t = a.traits || { riff:'Meh', vox:'Meh', dob:'Meh', mix:'Meh', szoveg:'Meh', vibe:'Meh' };

			const traitsHtml = `
				<div class="traits-container">
					<div class="traits-title">Teccet-e?</div>
					<div class="trait-pill"><span class="trait-name">RIFFEK</span><span class="${getTClass(t.riff)}">${t.riff}</span></div>
					<div class="trait-pill"><span class="trait-name">VOX</span><span class="${getTClass(t.vox)}">${t.vox}</span></div>
					<div class="trait-pill"><span class="trait-name">DOBOK</span><span class="${getTClass(t.dob)}">${t.dob}</span></div>
					<div class="trait-pill"><span class="trait-name">MIX</span><span class="${getTClass(t.mix)}">${t.mix}</span></div>
					<div class="trait-pill"><span class="trait-name">SZ√ñVEG</span><span class="${getTClass(t.szoveg)}">${t.szoveg}</span></div>
					<div class="trait-pill"><span class="trait-name">VIBE</span><span class="${getTClass(t.vibe)}">${t.vibe}</span></div>
				</div>
			`;
			container.innerHTML += `
				<div class="album-card" id="card-${idx}">
					<div class="row-number">${idx+1}</div>
					<div class="album-art-container">
						<img src="${a.coverUrl || 'https://via.placeholder.com/120'}" class="album-art-blur">
						<img src="${a.coverUrl || 'https://via.placeholder.com/120'}" class="album-art" onclick="openLB('${a.coverUrl}')">
					</div>
					<div class="album-info">
						<div style="display: flex; justify-content: space-between; align-items: flex-start;">
							<div>
								<h3 class="artist-name" onclick="qFilter('a', '${a.artist.replace(/'/g, "\\'")}')">${a.artist}</h3>
								<p><strong>${a.album}</strong> (${a.year||'?'})</p>
							</div>
							<div style="display: flex; align-items: center; gap: 10px;">
								${getRecommenderHTML(a.recommender)}
								<div class="score-badge" style="background:hsl(${(a.myScore-1)*13},70%,40%); position: static;">${parseFloat(a.myScore).toFixed(1)}</div>
							</div>
						</div>
						<small>${a.genre}</small>
						${a.review ? `<p class="review-text">${a.review}</p>` : ''}
						
						${traitsHtml}
						
						${a.favSong ? `<div class="song-container"><span class="song-label">${songLabel}</span><a href="${a.songUrl}" target="_blank" class="fav-song-link">${a.favSong}</a></div>` : ''}
						
						<div style="margin-top: auto; padding-top: 15px; display: flex; align-items: center; gap: 10px; font-size: 0.8em;">
							<span style="color: #666;">hozz√°adva: <strong style="color: #888;">${a.addedDate || '≈êsid≈ëkben'}</strong></span>
							
<button data-html2canvas-ignore class="edit-btn" onclick="editAlbum(${idx})" style="background:none; border:none; color:var(--accent); cursor:pointer; font-weight:bold; padding:0; text-decoration: underline;">‚úé SZERKESZT√âS</button>						</div>
					</div>
					
					<button data-html2canvas-ignore class="btn-snap" onclick="captureCard(this.parentElement, '${a.album.replace(/'/g, "\\'")}')" title="K√©p ment√©se">üì∑</button>
					
					<button data-html2canvas-ignore class="btn-del" onclick="deleteAlbum(${idx}, 'lib')">‚úñ</button>
				</div>`;
		});
		if (totalItems > 0) renderPagination(totalPages, totalItems);
	}

	window.captureCard = async function(cardElement, albumName) {
		const img = cardElement.querySelector('.album-art');
		const originalSrc = img.src;

		if (!img.src.includes('data:image')) {
			img.crossOrigin = "anonymous";
			img.src = `https://images.weserv.nl/?url=${encodeURIComponent(originalSrc)}`;
		}
		await new Promise(r => setTimeout(r, 1000));

		html2canvas(cardElement, {
			useCORS: true,
			allowTaint: false,
			backgroundColor: "#1a1a1a", // A k√°rtya h√°tt√©rsz√≠ne a k√©pen
			scale: 2,
			logging: false
		}).then(canvas => {
			const link = document.createElement('a');
			link.download = `${albumName}_review.png`;
			link.href = canvas.toDataURL("image/png");
			link.click();
			
			// Vissza√°ll√≠tjuk az eredeti linket a weboldalon
			img.src = originalSrc;
		}).catch(err => {
			console.error("Hiba:", err);
			img.src = originalSrc;
		});
	}

	window.statsToLibrary = function(recId) {
		// 1. √Åtv√°ltunk a k√∂nyvt√°r oldalra
		showPage('library');
	
		const searchInput = document.getElementById('gSearch');
		if (searchInput) {
			// Be√≠rjuk az id-t (pl. baal)
			searchInput.value = recId;
		
			if (typeof runFilter === "function") {
				currentPage = 1;
				runFilter();
			}
		}
	};

	window.filterByScore = function(score) {
		// 1. √Åtv√°ltunk a k√∂nyvt√°rba
		showPage('library');
		
		// 2. Be√°ll√≠tjuk a keres≈ët
		const searchInput = document.getElementById('gSearch');
		if (searchInput) {
			// Be√≠rjuk a pontsz√°mot (pl. "8.5")
			searchInput.value = score;
			
			// 3. Friss√≠tj√ºk a list√°t
			if (typeof runFilter === "function") {
				currentPage = 1;
				runFilter();
			}
			
			// G√∂rd√ºl√©s a tetej√©re
			window.scrollTo(0, 0);
		}
	};

// 1. K√©t seg√©df√ºggv√©ny a lapoz√°shoz √©s a bont√°s be√°ll√≠t√°s√°hoz
window.changePage = function(pageNumber) {
    currentPage = pageNumber;
    window.runFilter(); // Vagy sim√°n runFilter(), ha a modulon bel√ºl h√≠vod
    window.scrollTo(0, 0); // Opcion√°lis extra: lapoz√°skor felugrik az oldal tetej√©re
};

window.changeItemsPerPage = function(amount) {
    itemsPerPage = parseInt(amount);
    currentPage = 1;
    window.runFilter();
};

// 2. A m√≥dos√≠tott renderPagination
window.renderPagination = function(totalPages, totalItems) {
	const container = document.getElementById('listContainer');
	let html = `
		<div class="pagination-container">
			<div style="display:flex; align-items:center; gap:10px;">
				<span>Bont√°s:</span>
				<select onchange="window.changeItemsPerPage(this.value);" style="width:80px; padding:5px;">
					<option value="10" ${itemsPerPage==10?'selected':''}>10</option>
					<option value="25" ${itemsPerPage==25?'selected':''}>25</option>
					<option value="50" ${itemsPerPage==50?'selected':''}>50</option>
					<option value="100" ${itemsPerPage==100?'selected':''}>100</option>
				</select>
				<small style="color:#888;">(Tal√°latok: ${totalItems})</small>
			</div>
			<div class="page-btns">
				<button class="page-btn" onclick="window.changePage(1);" ${currentPage==1?'disabled':''}>¬´</button>
				${Array.from({length: totalPages}, (_, i) => i + 1).map(p => {
					if (totalPages > 10 && Math.abs(p - currentPage) > 2 && p !== 1 && p !== totalPages) return p === 2 || p === totalPages - 1 ? '...' : '';
					return `<button class="page-btn ${p===currentPage?'active':''}" onclick="window.changePage(${p});">${p}</button>`;
				}).join('').replace(/\.\.\.\.\.\./g, '...')}
				<button class="page-btn" onclick="window.changePage(${totalPages});" ${currentPage==totalPages?'disabled':''}>¬ª</button>
			</div>
		</div>`;
	container.innerHTML += html;
}

	window.renderTodo = function() {
		const container = document.getElementById('todoContainer');
		if(!container) return;
		container.innerHTML = '';
		todos.forEach((t, i) => {
			container.innerHTML += `
				<div class="album-card">
					<div class="row-number">${i+1}</div>
					<img src="${t.coverUrl || 'https://via.placeholder.com/120'}" class="album-art">
					<div class="album-info">
						<div style="display: flex; justify-content: space-between; align-items: flex-start;">
							<div>
								<h3 class="artist-name">${t.artist}</h3>
								<p><strong>${t.album}</strong></p>
							</div>
							${getRecommenderHTML(t.recommender)}
						</div>
						<div style="margin-top: 10px; display: flex; gap: 10px;">
							<button class="btn-check" onclick="moveToRating(${i})">‚úì</button>
						</div>
						<button class="btn-del" onclick="deleteAlbum(${i}, 'todo')">‚úñ</button>
					</div>
				</div>`;
		});
	}

	window.moveToRating = function(idx) {
		const item = todos[idx];
		document.getElementById('inArtist').value = item.artist;
		document.getElementById('inAlbum').value = item.album;
		document.getElementById('inCover').value = item.coverUrl;
		
		// Ez biztos√≠tja, hogy az aj√°nl√≥ leg√∂rd√ºl≈ë men√ºje is be√°lljon
		const recSelect = document.getElementById('inRec');
		if (recSelect) {
			recSelect.value = item.recommender || "";
		}
		
		showPage('library'); 
		toggleMod('add');
		todos.splice(idx, 1); 
		localStorage.setItem('slopTodo', JSON.stringify(todos));
		renderTodo(); // Friss√≠tj√ºk a n√©zetet
	}

	window.deleteAlbum = function(i, type) {
		if(!confirm("T√∂rl√©s?")) return;
		if(type === 'lib') albums.splice(i, 1); else todos.splice(i, 1);
		localStorage.setItem('slopLibrary', JSON.stringify(albums));
		localStorage.setItem('slopTodo', JSON.stringify(todos));
		location.reload();
	}

	window.editAlbum = function(i) {
		editIdx = i; 
		const a = albums[i];
		document.getElementById('inArtist').value = a.artist;
		document.getElementById('inAlbum').value = a.album;
		document.getElementById('inCover').value = a.coverUrl;
		document.getElementById('inYear').value = a.year;
		document.getElementById('inGenre').value = a.genre;
		document.getElementById('inScore').value = a.myScore;
		document.getElementById('inReview').value = a.review || "";
		document.getElementById('inFavSong').value = a.favSong || "";
		document.getElementById('inSongUrl').value = a.songUrl || "";
		document.getElementById('inDate').value = '';
		document.getElementById('inRec').value = a.recommender || "";
		const t = a.traits || { riff:'Meh', vox:'Meh', dob:'Meh', mix:'Meh', szoveg:'Meh', vibe:'Meh' };

		document.getElementById('t_riff').value = t.riff;
		document.getElementById('t_vox').value = t.vox;
		document.getElementById('t_dob').value = t.dob;
		document.getElementById('t_mix').value = t.mix;
		document.getElementById('t_szoveg').value = t.szoveg;
		document.getElementById('t_vibe').value = t.vibe;

		toggleMod('add'); window.scrollTo(0,0);
		document.getElementById('inDate').value = (a.addedDate && a.addedDate !== '≈êsid≈ëkben') ? a.addedDate : '';
		showModal('album');
	}

	window.renderSettings = function() {
		document.getElementById('setRareLimit').value = rareLimit;
		const gs = new Set(); albums.forEach(a=>a.genre.split(',').forEach(g=>gs.add(g.trim())));
		const container = document.getElementById('setG');
		if(!container) return;
		container.innerHTML = [...gs].sort().map(g => `
			<div class="settings-row">
				<span>${g}</span>
				<button onclick="tSlop('${g.toLowerCase()}')" style="background:${slopG.includes(g.toLowerCase())?'var(--accent)':'#444'}; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; color:${slopG.includes(g.toLowerCase())?'#000':'#fff'}; font-weight:bold;">
					${slopG.includes(g.toLowerCase())?'SLOP':'RENDES'}
				</button>
			</div>`).join('');
	}

	window.tSlop = function(g) { slopG.includes(g) ? slopG=slopG.filter(x=>x!==g) : slopG.push(g); localStorage.setItem('slopSettings', JSON.stringify(slopG)); renderSettings(); }

	window.openLB = function(src) { if(src) { document.getElementById('lb-img').src=src; document.getElementById('lightbox').style.display='flex'; } }
	
	window.resetFilters = function() { 
		document.querySelectorAll('#mod-search select, #mod-search input').forEach(i=>i.value=''); 
		albums.sort((a, b) => {
			let indexA = albums.indexOf(a);
			let indexB = albums.indexOf(b);
			return indexB - indexA; 
		});
		currentPage=1; 
		runFilter(); }

	window.qFilter = function(type, val) { 
		showPage('library'); 
		document.getElementById('mod-search').style.display='block'; 
		resetFilters(); 
		if(type==='g') document.getElementById('fGenre').value=val; 
		if(type==='y') document.getElementById('fYear').value=val; 
		if(type==='a') document.getElementById('fArtist').value=val; 
		currentPage = 1; runFilter(); 
	}

window.handleCSV = function() {
    const file = document.getElementById('csvFileInput').files[0];
    if(!file) return alert("Nincs f√°jl!");
    
    const r = new FileReader();
    r.onload = async function(e) { // Async-re v√°ltunk a Firebase miatt
        const lines = e.target.result.split('\n');
        const h = lines[0].toLowerCase().trim().split(';');
        const nA = [];
        
        for(let i=1; i<lines.length; i++) {
            if(!lines[i].trim()) continue;
            const c = lines[i].split(';'); 
            const o = {};
            
            h.forEach((name, idx) => {
                let v = c[idx] ? c[idx].trim() : "";
                if(name.includes('artist')||name.includes('el≈ëad√≥')) o.artist = v;
                if(name.includes('album')) o.album = v;
                if(name.includes('year')||name.includes('√©v')) o.year = v;
                if(name.includes('genre')||name.includes('m≈±faj')) o.genre = v;
                if(name.includes('score')||name.includes('pont')) o.myScore = parseFloat(v.replace(',','.'))||0;
                if(name.includes('cover')) o.coverUrl = v;
                if(name.includes('review')||name.includes('v√©lem√©ny')) o.review = v;
                if(name === 'favorite') o.favSong = v;
                if(name === 'link') o.songUrl = v;
                // Ha vannak traits (riff, vox stb.) oszlopaidd is a CSV-ben, azokat is itt adhatod hozz√°
            });
            if(o.artist && o.album) nA.push(o);
        }

        if(nA.length) { 
            // 1. Friss√≠tj√ºk a helyi list√°t
            albums = [...albums, ...nA]; 
            
            // 2. Ment√©s a Firebase-be (√©s opcion√°lisan localStorage-ba biztons√°g kedv√©√©rt)
            try {
                await window.saveToFirebase(); 
                localStorage.setItem('slopLibrary', JSON.stringify(albums));
                
                alert(nA.length + " album hozz√°adva √©s felh≈ëbe mentve!");
                location.reload(); 
            } catch (err) {
                console.error("Hiba az import√°l√°s k√∂zben:", err);
                alert("Hiba t√∂rt√©nt a felh≈ëbe ment√©skor!");
            }
        }
    };
    r.readAsText(file, "UTF-8");
}

	window.initFilters = function() {
		const fill = (id, data, label) => { 
			const el = document.getElementById(id);
			if(el) el.innerHTML = `<option value="">${label}</option>` + [...new Set(data)].sort().map(d=>`<option value="${d}">${d}</option>`).join(''); 
		};
		fill('fArtist', albums.map(a=>a.artist), "√ñsszes el≈ëad√≥");
		fill('fYear', albums.map(a=>a.year).filter(y=>y), "√ñsszes √©v");
		const gs = new Set(); albums.forEach(a=>a.genre.split(',').forEach(g=>gs.add(g.trim())));
		fill('fGenre', [...gs], "Minden m≈±faj");
	}

	window.runFilter = function() {
		const q = document.getElementById('gSearch').value.trim();
		const fA = document.getElementById('fArtist').value;
		const fY = document.getElementById('fYear').value;
		const fG = document.getElementById('fGenre').value;
		const sField = document.getElementById('sortField').value;

		// 1. Sz≈±r√©s
		let res = albums.filter(a => {
			// Keres√©s az el≈ëad√≥ban, albumban vagy az aj√°nl√≥ nev√©ben
			const searchTerm = q.toLowerCase();
			
			// Megn√©zz√ºk az aj√°nl√≥ nev√©t is az adatb√°zisodb√≥l (recommenders objektum)
			const recInfo = recommenders[a.recommender] || {};
			const recName = (recInfo.name1 || "").toLowerCase();
			
			// okos pontsz√°m keres√©s 
			const searchAsNumber = parseFloat(searchTerm);
			const isNumeric = !isNaN(searchAsNumber);
			
			// Csak akkor egyezzen a pontsz√°m, ha a sz√°m√©rt√©k PONTOSAN ugyanaz
			const scoreMatch = isNumeric && parseFloat(a.myScore) === searchAsNumber;

			let traitMatch = false;
			if (a.traits) {
				traitMatch = Object.values(a.traits).some(val => 
					val && val.toLowerCase().includes(searchTerm)
				);
			}

			const mQ = !q || 
					   a.artist.toLowerCase().includes(searchTerm) || 
					   a.album.toLowerCase().includes(searchTerm) ||
					   recName.includes(searchTerm) || 
					   scoreMatch ||
					   traitMatch;

			const mA = !fA || a.artist === fA;
			const mY = !fY || String(a.year) === fY;
			const mG = !fG || a.genre.split(',').map(g=>g.trim().toLowerCase()).includes(fG.toLowerCase());
			
			return mQ && mA && mY && mG;
		});

		// 2. Rendez√©s
		res.sort((a, b) => {
			let valA, valB;

			if (sField === 'id') {
				// Az eredeti index alapj√°n (Hozz√°ad√°s sorrendje)
				valA = albums.indexOf(a);
				valB = albums.indexOf(b);
			} else if (sField === 'score') {
				valA = parseFloat(a.myScore) || 0;
				valB = parseFloat(b.myScore) || 0;
			} else {
				// Sz√∂veges vagy numerikus mez≈ëk (artist, album, year, genre)
				valA = (a[sField] || "").toString().toLowerCase();
				valB = (b[sField] || "").toString().toLowerCase();
			}

			if (valA < valB) return sortAsc ? -1 : 1;
			if (valA > valB) return sortAsc ? 1 : -1;
			return 0;
		});

		renderList(res);
	}

	window.renderStats = function() {
		if(!albums.length) return;
		
		const years = {}, genres = {}, gScores = {}, yScores = {};
		let sCount = 0;
		let totalScore = 0;
		let totalWords = 0;
		const uniqueArtists = new Set();
		const uniqueGenres = new Set();

		let validAlbumCount = 0;
		albums.forEach(a => {
			const s = parseFloat(a.myScore) || 0;

			// Csak ha van √©rv√©nyes pontsz√°m (nagyobb, mint 0)
			if (s > 0) {
				totalScore += s;
				validAlbumCount++;
			}

			uniqueArtists.add(a.artist);
			if(a.review) totalWords += a.review.trim().split(/\s+/).filter(w => w.length > 0).length;

			if(a.year) { 
				years[a.year] = (years[a.year] || 0) + 1; 
				if(!yScores[a.year]) yScores[a.year] = []; 
				// Csak az √©rv√©nyes pontokat gy≈±jtj√ºk a statisztik√°hoz
				if (s > 0) yScores[a.year].push(s); 
			}

			const tags = String(a.genre).split(',').map(t => t.trim());
			let isS = false;
			tags.forEach(t => { 
				if(t) { 
					uniqueGenres.add(t);
					genres[t] = (genres[t] || 0) + 1; 
					if(!gScores[t]) gScores[t] = []; 
					// Csak az √©rv√©nyes pontokat gy≈±jtj√ºk a statisztik√°hoz
					if (s > 0) gScores[t].push(s); 
					if(slopG.includes(t.toLowerCase())) isS = true; 
				}
			});
			if(isS) sCount++;
		});

		document.getElementById('stat-total-albums').innerText = albums.length;
		document.getElementById('stat-total-artists').innerText = uniqueArtists.size;
		document.getElementById('stat-total-genres').innerText = uniqueGenres.size;
		document.getElementById('stat-avg-score').innerText = validAlbumCount > 0 ? (totalScore / validAlbumCount).toFixed(2) : "0.00";
		document.getElementById('stat-total-yap').innerText = totalWords + " sz√≥";

		const getMedian = (obj) => {
			const vals = Object.values(obj).sort((a, b) => a - b);
			if (vals.length === 0) return 1;
			const mid = Math.floor(vals.length / 2);
			const m = vals.length % 2 !== 0 ? vals[mid] : (vals[mid - 1] + vals[mid]) / 2;
			return Math.max(1, Math.floor(m));
		};

		const gMedian = getMedian(genres);
		const yMedian = getMedian(years);

		document.getElementById('topTitle').innerHTML = `Top 10 <span style="font-size:0.6em; color:#888; font-weight:normal; margin-left:10px;">(min.${gMedian}/m≈±faj, min.${yMedian}/√©v)</span>`;

		// --- TOP LIST√ÅK GENER√ÅL√ÅSA ---
		const drawTopList = (scoreObj, countObj, type, threshold) => {
		return Object.entries(scoreObj)
			.filter(([name, scores]) => scores.length >= threshold) // Scores m√°r csak a >0-kat tartalmazza
			.map(([name, scores]) => ({
				name, 
				avg: scores.reduce((p, c) => p + c, 0) / scores.length,
				count: scores.length
			}))
			.sort((a, b) => topSortAsc ? a.avg - b.avg : b.avg - a.avg)
			.slice(0, 10)
			.map(i => `
				<li onclick="qFilter('${type}','${i.name}')">
					<div style="display:flex; flex-direction:column;">
						<span>${i.name}</span>
						<small style="color:#888; font-size:0.7em;">${i.count} db</small>
					</div>
					<span class="stat-score-pill" style="background:hsl(${(i.avg-1)*13},70%,40%)">${i.avg.toFixed(2)}</span>
				</li>`).join('');
		};

	// A c√≠m friss√≠t√©se is figyeljen az ir√°nyra
	const topLabel = topSortAsc ? "Bottom 10" : "Top 10";
	document.getElementById('topTitle').innerHTML = `${topLabel} <span style="font-size:0.6em; color:#888; font-weight:normal; margin-left:10px;">(min.${gMedian}/m≈±faj, min.${yMedian}/√©v)</span>`;


		document.getElementById('topG').innerHTML = drawTopList(gScores, genres, 'g', gMedian);
		document.getElementById('topY').innerHTML = drawTopList(yScores, years, 'y', yMedian);

		const genreEntries = Object.entries(genres);
		const mainGenresSorted = genreEntries.filter(e => e[1] >= rareLimit).sort((a, b) => b[1] - a[1]);
		const rareSum = genreEntries.filter(e => e[1] < rareLimit).reduce((acc, curr) => acc + curr[1], 0);

		let chartLabels = mainGenresSorted.map(e => e[0]);
		let chartData = mainGenresSorted.map(e => e[1]);
		if(rareSum > 0) { chartLabels.push("Egy√©b (ritka)"); chartData.push(rareSum); }

	if(charts.traits) charts.traits.destroy();
	// --- TECCET-E STATISZTIKA ---
    const traitKeys = ['riff', 'vox', 'dob', 'mix', 'szoveg', 'vibe'];
    const traitLabels = ['RIFFEK', 'VOX', 'DOBOK', 'MIX', 'SZ√ñVEG', 'VIBE'];
    const ratings = ['Peak', 'Igen', 'Meh', 'Nem', 'Poop', 'Volt??'];
    const rColors = { 
        'Peak': '#ffcc00', 
        'Igen': '#44ff44', 
        'Meh': '#888888', 
        'Nem': '#ff4444', 
        'Poop': '#8b4513', 
        'Volt??': '#bb88ff' 
    };

    // Adatok el≈ëk√©sz√≠t√©se (sz√°ml√°l√°s)
    let traitCounts = {};
    ratings.forEach(r => { traitCounts[r] = [0,0,0,0,0,0]; });

    albums.forEach(a => {
        const t = a.traits || { riff:'Meh', vox:'Meh', dob:'Meh', mix:'Meh', szoveg:'Meh', vibe:'Meh' };
        traitKeys.forEach((key, i) => {
            const val = t[key] || 'Meh';
            if (traitCounts[val]) traitCounts[val][i]++;
        });
    });

    // Diagram l√©trehoz√°sa
    const totalAlbums = albums.length;
    charts.traits = new Chart(document.getElementById('chartTraits'), {
        type: 'bar',
        data: {
            labels: traitLabels,
            datasets: ratings.map(r => ({
                label: r,
                data: traitCounts[r].map(c => totalAlbums ? Math.round((c / totalAlbums) * 100) : 0),
                backgroundColor: rColors[r]
            }))
        },
        options: {
            indexAxis: 'y', // Ett≈ël lesz v√≠zszintes a s√°v
			
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true, max: 100, display: false },
                y: { stacked: true, ticks: { color: '#eee', font: { weight: 'bold' } } }
            },
            plugins: {
                legend: { position: 'bottom', labels: { color: '#ccc', boxWidth: 12 } },
                datalabels: {
                    color: '#000',
                    font: { weight: 'bold', size: 10 },
                    formatter: (v) => v > 5 ? v + '%' : '' // Csak akkor √≠rja ki, ha van hely
                }
            }
        }
    });

	if(charts.g) charts.g.destroy();
		charts.g = new Chart(document.getElementById('cGenre'), { 
			type: 'pie', 
			data: { 
				labels: chartLabels, 
				datasets: [{ 
					data: chartData, 
					backgroundColor: chartLabels.map((l, i) => l === "Egy√©b (ritka)" ? "#444" : `hsl(48, 100%, ${Math.max(15, 65 - i * 4)}%)`), 
					borderWidth: 1, 
					borderColor: '#1e1e1e' 
				}] 
			}, 
			options: { 
			devicePixelRatio: 2,
				onClick: (e, el) => { 
					if(el[0]) { 
						const label = chartLabels[el[0].index]; 
						if(label !== "Egy√©b (ritka)") {
							qFilter('g', label); 
						} else {
							// Leg√∂rd√≠t a ritkas√°gok list√°j√°hoz
							document.getElementById('listRare').scrollIntoView({ behavior: 'smooth' });
						}
					} 
				},
				onHover: (event, chartElement) => {
					// Mutat√≥ujjas kurzor, ha szelet f√∂l√© √©rsz
					event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
				},
				maintainAspectRatio: false, 
				layout: { 
					padding: {
						top: 10,
						bottom: 10,
						left: 60,
						right: 60
					} 
				}, 
				plugins: { 
					title: { display: false }, 
					legend: { display: false }, 
					datalabels: { 
						anchor: 'end', 
						align: 'end', 
						color: '#ccc', 
						offset: 8, 
						formatter: (v, ctx) => ctx.chart.data.labels[ctx.dataIndex] 
					} 
				} 
			}
		});

		if(charts.y) charts.y.destroy();
		const ySorted = Object.keys(years).sort();
		charts.y = new Chart(document.getElementById('cYear'), { 
			type:'bar', data:{labels:ySorted, datasets:[{data:ySorted.map(k=>years[k]), backgroundColor:'#ffcc00'}]}, 
			options:{ 
				devicePixelRatio: 2,
				onClick:(e, el)=>{if(el[0]) qFilter('y', ySorted[el[0].index]);}, 
				maintainAspectRatio:false, layout: { padding: { top: 25 } },
				plugins:{ legend:{display:false}, datalabels:{ display: true, anchor: 'end', align: 'top', color: '#ffcc00', font: { weight: 'bold', size: 11 }, formatter: v => v }},
				scales: { y: { beginAtZero: true, grid: { color: '#333' }, ticks: { display: false } }, x: { grid: { display: false }, ticks: { color: '#ccc', autoSkip: false, maxRotation: 90, minRotation: 90 } } }
			}
		});

		if(charts.s) charts.s.destroy();
		const p = albums.length > 0 ? (sCount/albums.length*100).toFixed(1) : 0;
		charts.s = new Chart(document.getElementById('cSlop'), { 
			type:'bar', data:{labels:[''], datasets:[{data:[p], backgroundColor:'#ffcc00'}, {data:[100-p], backgroundColor:'#333'}]}, 
			options:{
				devicePixelRatio: 2,
				maintainAspectRatio:false, 
				scales:{x:{stacked:true, display:false}, y:{stacked:true, max:100, display:false}}, 
				plugins:{datalabels:{color:'#fff', formatter:v=>v+'%'}, 
				legend:{display:false}}}});

		document.getElementById('listRare').innerHTML = genreEntries.filter(e => e[1] < rareLimit).sort((a,b)=>b[1]-a[1]).map(r=>`<li onclick="qFilter('g','${r[0]}')">${r[0]} <span>${r[1]} db</span></li>`).join('');

		// 1. Adatok kisz√°m√≠t√°sa
		const recStats = Object.keys(recommenders).map(key => {
			const rData = recommenders[key];
			// Csak azokat az albumokat n√©zz√ºk, amikn√©l az aj√°nl√≥ egyezik √âS a pontsz√°m > 0
			const rAlbums = albums.filter(a => a.recommender === key && (parseFloat(a.myScore) || 0) > 0);
			const count = rAlbums.length;
			const avg = count > 0 ? rAlbums.reduce((sum, a) => sum + (parseFloat(a.myScore) || 0), 0) / count : 0;
			return { key, ...rData, count, avg };
		});

		// 2. A kirajzol√≥ bels≈ë f√ºggv√©ny
		const drawRecStats = (data) => {
			const container = document.getElementById('listRecStats');
			if(!container) return;

			let html = `
				<li style="background:none; border:none; cursor:default; font-weight:bold; color:var(--accent); font-size:14px; padding:0 10px; min-height:auto; margin-bottom:5px;">
					<div style="flex:1;">N√âV</div>
					<div style="width:100px; text-align:center; cursor:pointer;" onclick="sortRecStats('count')">DARAB ‚áÖ</div>
					<div style="width:100px; text-align:right; cursor:pointer;" onclick="sortRecStats('avg')">√ÅTLAG ‚áÖ</div>
				</li>
			`;

			data.forEach(r => {
						html += `
							<li onclick="window.statsToLibrary('${r.name1}')" style="cursor:pointer; padding: 12px 10px; border-bottom: 1px solid #333;" class="rec-stat-row">
								<div style="flex:1; display:flex; align-items:center;">
									<div class="recommender-tag" style="border-color: ${r.color}; color: ${r.textColor || r.color}; margin:0; padding: 6px 12px; min-width: 140px;">
										<span class="rec-title" style="font-size: 14px; display: block; line-height: 1.2;">${r.name1}</span>
										<span class="rec-subtitle" style="font-size: 10px; display: block; opacity: 0.8;">${r.name2}</span>
									</div>
								</div>
								<div style="width:100px; text-align:center; font-weight:bold; font-size:18px;">${r.count}</div>
								<div class="stat-score-pill" style="background:hsl(${(r.avg-1)*13},70%,40%); min-width:65px; font-size:16px; padding: 6px;">${r.avg.toFixed(2)}</div>
							</li>
						`;
			});
			container.innerHTML = html;
		};

		// 3. Kezdeti megjelen√≠t√©s (alap sorrend szerint)
		drawRecStats(recStats);

		// 4. A glob√°lis rendez≈ë f√ºggv√©ny (hogy a gombok m≈±k√∂djenek)
		window.sortRecStats = function(field) {
			if (!window.recSortConfig) window.recSortConfig = { field: null, asc: false };
			
			if (window.recSortConfig.field === field) {
				window.recSortConfig.asc = !window.recSortConfig.asc;
			} else {
				window.recSortConfig.field = field;
				window.recSortConfig.asc = false;
			}

			const sorted = [...recStats].sort((a, b) => {
				return window.recSortConfig.asc ? a[field] - b[field] : b[field] - a[field];
			});
			drawRecStats(sorted);
		};
		const statsToLibrary = (recId) => {
		
		
			// 1. √Åtv√°ltunk a k√∂nyvt√°r oldalra
			showPage('library');
			
			// 2. Be√°ll√≠tjuk a keres≈ët
			const searchInput = document.getElementById('gSearch');
			if (searchInput) {
				searchInput.value = recId; // A 'baal', 'goatlord' stb. azonos√≠t√≥t haszn√°ljuk
				currentPage = 1;
				runFilter();
			}
		};

	const scoreLabels = [];
	for (let s = 1.0; s <= 10.0; s += 0.5) {
		scoreLabels.push(s.toFixed(1)); 
	}

// 2. Adatok √∂sszes√≠t√©se
	const scoreCounts = new Array(scoreLabels.length).fill(0);
	albums.forEach(a => {
		const val = parseFloat(a.myScore);
		if (!isNaN(val) && val >= 1 && val <= 10) {
			// Kerek√≠t√©s a legk√∂zelebbi 0.5-re
			const rounded = Math.round(val * 2) / 2;
			const index = Math.round((rounded - 1) * 2);
			if (index >= 0 && index < scoreCounts.length) {
				scoreCounts[index]++;
			}
		}
	});

// 3. Grafikon l√©trehoz√°sa Pontok eloszl√°s√°hoz
const ctxScore = document.getElementById('cScoreDist').getContext('2d');
new Chart(ctxScore, {
	type: 'bar',
	data: {
		labels: scoreLabels,
		datasets: [{
			label: 'Albumok sz√°ma',
			data: scoreCounts,
			backgroundColor: '#ffcc00', // Teljesen s√°rga, nem √°tl√°tsz√≥
			borderColor: '#ffcc00',
			borderWidth: 1,
			borderRadius: 4
		}]
	},
	options: {
			devicePixelRatio: 3,
			responsive: true,
			maintainAspectRatio: false,
			onClick: (event, elements) => {
				if (elements.length > 0) {
					const index = elements[0].index;
					const scoreValue = scoreLabels[index]; // Megkapjuk pl. "8.5"
					
					// Megh√≠vjuk a sz≈±r√©st (azt a f√ºggv√©nyt haszn√°ljuk, amit kor√°bban √≠rtunk)
					// De mivel ez pontsz√°m, egy kicsit m√≥dos√≠tjuk a logik√°t
					filterByScore(scoreValue);
				}
			},
			// Adjunk egy kis helyet a grafikon tetej√©n, hogy a sz√°mok elf√©rjenek
			layout: {
				padding: {
					top: 25 
				}
			},
			plugins: {
				legend: { display: false },
				// EZ AZ √öJ R√âSZ: A sz√°mok megjelen√≠t√©se az oszlopok felett
				datalabels: {
					anchor: 'end', // Az oszlop v√©g√©hez r√∂gz√≠ti
					align: 'top',  // Az oszlop f√∂l√© teszi
					color: '#ffcc00', // S√°rga sz√≠n
					font: {
						weight: 'bold',
						size: 14
					},
					// Csak akkor mutassa a sz√°mot, ha nagyobb, mint 0
					formatter: function(value) {
						return value > 0 ? value : '';
					}
				}
			},
			scales: {
				y: {
					beginAtZero: true,
					grid: { display: false }, // A v√≠zszintes r√°csvonalakat is kivehetj√ºk a tiszt√°bb k√©p√©rt
					ticks: { display: false },
					border: { display: false } // A tengely vonal√°t is elrejti
				},
				x: {
					grid: { display: false },
					ticks: { 
						color: '#e0e0e0',
						font: { size: 14, weight: 'bold' }
					}
				}
			}
		},
		// Fontos: Enged√©lyezni kell a b≈ëv√≠tm√©nyt a grafikonn√°l
		plugins: [ChartDataLabels]
});

	} 

window.captureStats = async function() {
	const msg = document.getElementById('snapshotMsg');
	const statsPage = document.getElementById('stats');
	const btnContainer = event.target.parentElement; // A gombot tartalmaz√≥ div

	// Vizu√°lis visszajelz√©s a gombon
	const originalBtnText = event.target.innerText;
	event.target.innerText = "‚åõ GENER√ÅL√ÅS...";
	event.target.disabled = true;

	// 1. ELREJTJ√úK a gombot a k√©pr≈ël
	btnContainer.style.display = 'none';

	try {
		const canvas = await html2canvas(statsPage, {
			backgroundColor: '#121212',
			scale: 3,
			logging: false,
			useCORS: true,
			scrollX: 0,
			scrollY: -window.scrollY,
			windowWidth: statsPage.scrollWidth,
			windowHeight: statsPage.scrollHeight
		});

		// 2. Visszahozzuk a gombot, amint megvan a "felv√©tel"
		btnContainer.style.display = 'block';

		canvas.toBlob(async (blob) => {
				try {
				const data = [new ClipboardItem({ [blob.type]: blob })];
				await navigator.clipboard.write(data);
				msg.innerText = "K√©p a v√°g√≥lapra m√°solva!";
				msg.style.display = 'block';
			} catch (err) {
				const link = document.createElement('a');
				link.download = 'slop_library_statisztika.png';
				link.href = canvas.toDataURL("image/png");
				link.click();
				msg.innerText = "V√°g√≥lap hiba - K√©p let√∂ltve!";
				msg.style.display = 'block';
			}
		});

	} catch (err) {
		console.error("Hiba:", err);
		btnContainer.style.display = 'block'; // Hiba eset√©n is hozzuk vissza a gombot
		alert("Hiba t√∂rt√©nt a gener√°l√°s k√∂zben.");
	} finally {
		event.target.innerText = originalBtnText;
		event.target.disabled = false;
	setTimeout(() => msg.style.display = 'none', 4000);
	}
}

async function saveToFirebase() {
    try {
        // Elmentj√ºk az eg√©szet egy "data" nev≈± kollekci√≥ "current" dokumentum√°ba
        await setDoc(doc(db, "data", "library"), {
            albums: albums,
			todos: todos
        });
        console.log("Sikeres ment√©s a felh≈ëbe!");
    } catch (e) {
        console.error("Hiba a ment√©s sor√°n: ", e);
    }
}
// Tegy√ºk el√©rhet≈ëv√© a localStorage ment√©s helyett is
window.saveToFirebase = saveToFirebase;

	// Inicializ√°l√°s
	initFilters();
	runFilter();
</script>
</body>

</html>

